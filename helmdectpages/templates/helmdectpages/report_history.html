{% extends "helmdectpages/base.html" %}
{% load filters %}

{% block css %}
<link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}
{% block content %}
<section class="py-5 mt-5">
    <form class="d-flex justify-content-center flex-wrap" method="post"
        data-bs-theme="light" style="margin-left: initial;">
        <div class="shadow-lg mb-3"><input class="form-control" type="email"
                name="search" placeholder="Search"></div>
        <div class="shadow-lg mb-3"><button class="btn btn-primary"
                type="submit">Search</button></div>
    </form>
</section>
<section>
    <div class="container py-4 py-xl-5">
        <div class="row mb-5">
            <div class="col-md-8 col-xl-6">
                <h3 class="display-6 fw-bold pb-4 mb-4">Reports:&nbsp;<span
                        class="underline">Captured Photos</span></h3>
            </div>
            <div class="col">
                <label for="dateFilter">Date Filter</label>
                <input type="text" id="dateFilter" class="form-control"
                    placeholder="Select Date">
            </div>
        </div>

        <div id="lightgallery">
            {% for key, value in reports.items %}
            {% with value.dateTime|timestamp_to_datetime as readable_datetime %}
            <a href="{{ value.image }}" data-lg-size="1024-768"
                data-sub-html="<p>Date Time: {{ readable_datetime }}</p><p>Helmet: {{ value.helmet }}</p><p>Location: {{ value.location }}</p><p>Plate Number: {{ value.plate_number }}</p><p>Violations: {{ value.violations }}</p><p>Number of Motorcyclists Detected: {{ value.number_of_motorcyclist_detected }}</p>">
                <img src="{{ value.image }}" alt="Image">
            </a>
            {% endwith %}
            {% endfor %}
        </div>

    </div>
</section>
{% include 'partials/footer.html' %}

{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // Initialize Flatpickr
    const dateFilter = document.getElementById('dateFilter');
    var queryParams = getQueryParams();
    var defaultDateRange = [];
    var startDate = queryParams['start_date'];
    var endDate = queryParams['end_date'];

    // Check if both dates are present in the query parameters
    if (startDate && endDate) {
        defaultDateRange = [startDate, endDate];
    }

    flatpickr(dateFilter, {
        mode: 'range', // Enable selecting a date range
        dateFormat: 'Y-m-d', // Date format,
        defaultDate: defaultDateRange,
        allowInput: true,
        allowClear: true,
        onClose: function(selectedDates, dateStr) {
            // When the user selects a date range, trigger the view with selected dates
            const [startDate, endDate] = dateStr.split(" to ");
            const url = `/report_history/?start_date=${startDate}&end_date=${endDate}`;

            window.location.href = url;
        }
    });
    function getQueryParams() {
        var queryParams = {};
        var queryString = window.location.search.substring(1);
        var params = queryString.split("&");
        for (var i = 0; i < params.length; i++) {
            var pair = params[i].split("=");
            queryParams[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
        }
        return queryParams;
    }
</script>
<script>
    const lightGalleryDiv = document.getElementById('lightgallery');

    lightGallery(lightGalleryDiv, {
        selector: 'a',
        thumbnail: true,
        download: false,
        zoom: true
        // Add more options as needed
    });
</script>

<script>
    // Function to open the image in a new tab
    function openImageInNewTab(base64ImageData) {
      var img = new Image();
      img.src = base64ImageData;

      var newTab = window.open();
      newTab.document.write('<html><head><title>Image</title></head><body></body></html>');
      newTab.document.body.appendChild(img);
    }

    // Attach click event listener to the image
    $('.img-fluid').on('click', function() {
      // Replace 'YOUR_BASE64_IMAGE_DATA' with your actual Base64 image data
      var base64ImageData = $(this).attr('src');
      openImageInNewTab(base64ImageData);
    });
  </script>
{% endblock %}